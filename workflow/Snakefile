configfile: "config/config.yaml"
# make output file for each organism
def get_final_output(wc):
    for org in config["genomes"]:
        yield f"results/structures/{org}.tsv.gz"

rule all:
    input: get_final_output

# extract the miRNA precursors sequences using the seq and ann files
rule extract_precursors:
    input: 
        seq=lambda wc: config["genomes"][wc.org]["seq"],
        ann=lambda wc: config["genomes"][wc.org]["ann"], #TODO: add path to annotations file
    output:
        "results/precursors/{org}.fa.gz"
    log: 
        stdout="logs/extract_precursors_{org}.stdout", 
        stderr="logs/extract_precursors_{org}.stderr"
    conda: "envs/extract_precursors.yaml"
    #TODO: implement the script (you may use an R script instead)
    shell: "python3 workflow/scripts/extract_precursors.py > {log.stdout} 2> {log.stderr} "

# predict the structure for all sequences in the fasta file (dot-bracket format)
rule predict_structure:
    input:
        "results/precursors/{org}.fa.gz"
    output:
        "results/structures/{org}.out.gz"
    log: 
        stdout="logs/predict_structure_{org}.stdout", 
        stderr="logs/predict_structure_{org}.stderr"
    conda: "envs/predict_structure.yaml"
    #TODO: write shell code to process structures
    #      you may choose to use a 'script' directive instead
    shell: """
        echo "Here we predict structures for {wildcards.org}" 
        gunzip {input}
        RNAfold --noPS -i {input[:-3]} > {output[:-3]}  > {log.stdout} 2> {log.stderr}
        gzip {output[:-3]} > {output}
    """

# convert the predictions output to a tsv file
# columns: sequence_id\tsequence\tstructure\tmfe
rule convert_to_tsv:
    input:
        "results/structures/{org}.out.gz"
    output:
        "results/structures/{org}.tsv.gz"
    log: 
        stdout="logs/convert_to_csv_{org}.stdout", 
        stderr="logs/convert_to_csv_{org}.stderr"
    #TODO: write shell code to convert the structures output to tsv
    shell: "python3 workflow/scripts/convert_to_tsv.py  > {log.stdout} 2> {log.stderr}"

